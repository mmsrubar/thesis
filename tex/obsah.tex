%=========================================================================
% (c) Michal Bidlo, Bohuslav Køena, 2008

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 1. Úvod
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Úvod}

1. Uvod by mel obsahovat zejmena nasledujici: Vymezeni sirsi oblasti, ve ktere
se prace pohybuje, a motivaci prace. Dale by tam mely byt stanoveny konkretni
cile (ktere samozrejme musi byt v souladu se zadanim, ale muzete si je
preformulovat do vet, ktere vam tam zapadnou). Pak by tam mela byt vysvetlena
struktura zbytku prace. Na cile a strukturu je mozne pouzit pojmenovane
odstavce. Muzete tam samozrejme mit i popis toho, co u ctenare ocekavate a co
neni cilem prace, ale asi bych to nedaval jako cislovane sekce, ale nanejvyse
jako pojmenovane odstavce.

{\color{red}{TODO: pøi svazování je potøeba je¹tì pøidat originál zadání!}}

\section{odstavec - co od ètenáøe oèekávám}
\begin{itemize}
	\item základní znalost adresáøù a protokolu LDAP
\end{itemize}

\section{odstavec - èím se tato práce nezabývá}
\begin{itemize}
	\item není to tutorial ani dokumentace k sssd, ipa nebo sudo
	\item je nutné vìdìt co jsou to Mock objekty pøi testování
\end{itemize}

\section{odstavec - pou¾itá symbolika}
\begin{itemize}
	\item názvy souborù, klíèových slov jazyka C, jmen identifikátorù je pou¾it
		texttt
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 2. Správa u¾ivatelských práv v doménì
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Správa politik identit v linuxových prostøedích}
Sepi¹ vice mo¾ností jakými je mo¾no delegovat práva a potom napi¹, ¾e v
následujícím textu se bude¹ zabývat právì SUDO+SSSD+IPA proto¾e je to roz¹íøené
mezi u¾ivateli RHELu.  Jestli¾e máme velký server a vice adminù starající se o
vice slu¾eb, tak nechceme ka¾dému dát heslo roota, ale radìji by jsme chtìli mít
mo¾nost delegovat urèitá prává. Tak stejnì u¾ivatelù by se sem tam hodily vy¹¹í
práva

- ¾e spravovat sudo lokálnì je pracné
- ¾e ve velké spoleènosti kde je linux prostøedí, chce mit admin vsechno
centralne

\begin{itemize}
	\item tato kapitole bude takový popis toho jak je mo¾né spravovat u¾ivatelská
		práva pomocí suda v doménì
	\item konkrétnì s vyu¾itím tìchto technologii (SUDO+IPA+SSSD)
	\item jaké problémy to pøiná¹í a jak je tyto technologie øe¹í (SUDO+IPA+SSSD)
\end{itemize}
%-------------------------------------------------------------------------------
\section{SUDO}

sudo umo¾òuje u¾ivateli operaèního systému spustit jeden pøíkaz jako jiný
u¾ivatel. Ve vìt¹inì pøípadù je jiným u¾ivatele root. Tedy správce operaèního
systému, který má nejvy¹¹í oprávnìní. Bezpeènostní politiky, kterými se sudo
øídí se nazývají sudo pravidla\footnote{dále oznaèovaná jako \texttt{sudoers}}.
Sudoers se zapisují v následujícím formátu:
\\
\lstset{language=bash}
\begin{lstlisting}
user host_list = ( user_list ) command_list
\end{lstlisting}


\begin{itemize}
	\item \texttt{user} definuje u¾ivatele nebo skupinu, na kterou se bude pravidlo aplikovat
	\item \texttt{host\_list} reprezentuje seznam koncových systému
	\item \texttt{user\_list} - (volitelné)
	\item \texttt{command\_list} - seznam povolených pøíkazù
\end{itemize}

Jestli-¾e chce správce systému, tj. u¾ivatel root, dát napøíklad u¾ivateli
\uv{adam} oprávnìní spou¹tìt pøíkaz \texttt{/sbin/fdisk} s právy u¾ivatele root, pak
musí definovat následující pravidlo:
\\
\texttt{adam client1.example.cz = /sbin/fdisk}

Sudo pravidla se definují v konfiguraèním souboru \texttt{/etc/sudoers}. Tento
soubor by mìl být editován pouze pomocí nástroje \emph{visudo}, který provádí
automatickou kontrolu syntaxe. Ve výchozím nastavení se v tomto souboru nachází
jediné pravidlo definující práva u¾ivatele root.
\\
\texttt{root ALL = ( ALL ) ALL}

Toto pravidlo dává u¾ivateli root oprávnìní spustit jakýkoliv pøíkaz, jako
jakýkoliv u¾ivatel na kterémkoliv systému, kde je toto pravidlo definováno.

\section{Distribuce sudo pravidel mezi vícepoèítaèù}
\label{sudoers_distribution} 
V rozsáhlej¹í sítích má administrátor na starost více ne¾ jednu koncovou
stanici. Ka¾dou stanici pou¾ívají u¾ivatelé, kteøí obèas potøebují provést
úlohu, pro kterou potøebují vy¹¹í oprávnìní. Proto by chtìl správce systému
¹íøit pravidla mezi více poèítaèù. Sudo ov¹em nemá nativní zpùsob jak
distribuovat sudo pravidla mezi více poèítaèù. Spravovat sudo pravidla ruènì na
v¹ech poèítaèích, které administrátor spravuje by bylo velice pracné a èasovì
nároèné. Viz. obrázek \ref{pic}.

Otázkou tedy zùstává jak sudo pravidla ¹íøit mezi více poèítaèù. Existuje
nìkolik zpùsobù jak toho docílit.

\begin{enumerate}
	\item Ruènì distribuovat sudo pravidla mezi více systému za pou¾ití
		standardních linuxových nástrojù jako jsou \emph{cron, scp, rsync, \dots}.
		Tento pøístup by mohl být velmi nároèný a né velmi spolehlivý 
	\item Pou¾ít speciální nástroje jako je napøíklad \emph{Puppet}, který sleduje
		a automaticky ¹íøí konfiguraèní soubory.  
	\item Ulo¾it sudo pravidla do centralizované databáze.
\end{enumerate}

\subsection{Sudo pravidla v LDAP adresáøi}
Adresáøe mohou uchovávat rùzné typy informací a jsou tak pou¾ívány organizacemi
a institucemi k ukládání informací o jejich zamìstnancích nebo u¾ivatelích
jejich poèítaèových sítí.

LDAP adresáøe jsou charakterizovány jako
"jednou-zapsat-a-mnohokrát-èíst"\footnote{write-once-read-many-times} slu¾ba.
Jsou optimalizovány pro rychlé ètení a vyhledávání, proto¾e pøedpokládají, ¾e
budou uchovávat informace, které nebudou pøíli¹ èasto modifikovány.\cite{dfs}.
Sudo pravidla jsou vìt¹inou jednou definována správcem systému a mnohokrát
pou¾ita u¾ivateli. Ulo¾ení sudo pravidel do LDAP adresáøe je tedy velice výhodné
a nabízí následující výhody:

\begin{enumerate}
	\item Jestli-¾e jsou sudo pravidla centralizována, pak se správce systému
		nemusí starat o jejich distribuci. Spravuje pouze jediný sudoers soubor.
	\item Vyhledávání sudo pravidla v LDAP adresáøi je rychlej¹í. Pøi pou¾ití
		lokálních sudoers\footnote{tj. kdy¾ jsou sudo pravidla definována v lokální
		\texttt{/etc/sudoers}souboru} musí sudo pøeèíst celý sudoer soubor. Pøi
		ulo¾ení sudoers v LDAP adresáøi je potøeba pouze nìkolik LDAP
		dotazù.\cite{sudoers_ldap_manual}.  
	\item Jesli-¾e udìlá správce v sudoers souboru chybu\footnote{Je mo¾né tomu
		pøedejít za pou¾ití nástroje \emph{visudo}, který neumo¾ní ulo¾it syntakticky
		nesprávnou konfiguraci}. Pak se sudo nespustí. Do LDAP adresáøe není mo¾né
		ulo¾it data, která nesplòují sudoers schéma. Správná syntaxe je tedy zaruèena,
		ale stále je mo¾né udìlat chybu v u¾ivatelském jménu, pøíkazu nebo názvu
		koncového systému.
\end{enumerate}

\begin{itemize}
	\item co to je a co nám to umo¾òuje dìlat
	\item jak to pracuje
	\item co to jsou sudo pravidla
	\item syntax sudo pravidel + obrázek s pøíkladem (pøíklad stejného pravidla
		jak by vypadalo v ldapu a pak v IPA)
\end{itemize}

\subsection{Distribuce sudo pravidel}
\begin{itemize}
	\item ¹íøení sudo pravidel mezi více poèítaèù je problém (obrázek: jeden administrator má nastarost spoustu strojù, kdy ka¾dý má vlasní sudoers soubor pravidel)
	\item mo¾ná øe¹ení toho problému
	\item mnoho spoleèností dnes LDAP pou¾ívá a celkem se hodí pro ulo¾ení sudo pravidel
\end{itemize}

\subsection{distribuce pravidel s pomocí LDAPu}
\begin{itemize}
	\item rozdíl mezi lokalním sudoers a sudoers v LDAPu (LDAP negarantuje poøadí
		v jakém vrací záznamy ani atributy)
	\item stejný pøíklad sudo pravidla jak by vypadalo v LDAPu
\end{itemize}

\section{Pluginy}
Jak bylo øeèeno v sekci \ref{sudoers_distribution} sudo nepodporuje zpùsob jak
sudo pravidla distribuovat. Od verze 1.8.0 ov¹em umo¾òuje pou¾ití politik
tøetích stran --->koukni na sudo a pluginy....

%-------------------------------------------------------------------------------

\section{FreeIPA}
Kvùli efektivitì a jednoduché správì se IT administrátoøi sna¾í spravovat
identity\footnote{Identita je objekt u kterého mnì zajímá jeho jednoznaèná
identifikace (v linuxových prostøedích to jsou napøíklad u¾ivatelé)} centrálnì
a spojovat identity s autentizaèími a autorizaèními politikami. V linuxových
prostøedích existuje mnoho protokolù pro rùzné slu¾by, které napøíkad definují
doménu (NIS\footnote{Network Information Service}, Kerberos), LDAP pro
uchování dat nebo sudo pro správu pøístupu. ®ádné z tìchto slu¾eb ov¹em nejsou
nijak propojeny a zároveò v¹echny musí být spravovány lokálnì. Administrátor
tedy musí mít potøebné znalosti v¹ech tìchto slu¾eb a protokolù aby je dokázal
správnì pou¾ívat a dané slu¾by spravovat. 

FreeIPA\footnote{Free  Identity, Policy and Audit, zkrácenì IPA}
je projekt, které se zamìøuje na správu identit (u¾ivatelé a poèítaèe) a
politik.  Projekt FreeIPA je postaven nad existujícími nativními linuxovými
aplikacemi a protokoly. Definuje doménu ve které se vyskytují servery, klienti a
vzájemnì mezi sebou sdílí centrálnì spravované slu¾by jako jsou napøíklad
Kerberos nebo DNS\footnote{Domain Name System}. Je tedy mo¾né øíci, ¾e je to v
podstatì doménový kontrolér pro linuxové a unixové stanice. Poskytuje jakousi
obálku nad standardizovanými sí»ovými slu¾bami jako jsou PAM, LDAP, Kerberos,
DNS, NTP nebo certifikaèní slu¾by. Jeho hlavní úlohou je tedy spravovat v¹echny tyto
slu¾by na jednom místì. IPA navíc umo¾òuje synchronizaci dat s Active Directory.
Neumí ov¹em windows klienty spravovat.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.65]{fig/ipa/ipa.pdf}
	\caption{FreeIPA sjednocuje slu¾by standartní slu¾by}
	\label{sssd_architecture}
\end{figure}

{\color{red}{TODO: u okazu na literaturu to mam napsat chapter nebo kapitola,
kdy¾ je lit. anglicky?}}
{\color{red}{TODO: Ten obrázek je z literatury [5], mohu ho tady tak sprostì
zkopírovat?}}

Jako úlo¾i¹tì ve¹kerých dat pou¾ívá pou¾ívá 389 adresáø\footnote{The 389
Directory Server, http://directory.fedoraproject.org}. Pro autentizaci je pou¾it
protokol ¾ívá Kerberos, který vyu¾ívá symetrickou kryptografii pro generování
\textit{ticketù}, které jsou pou¾ívány namísto klasických hesel. Jako
certifikaèní autoritu, které zaji¹tuje vystavování certifkátù serverùm, replikám
nebo klientù, IPA pou¾ívá \textit{Dogtag Certificate System}. Slu¾by jako
Kerberos jsou závislé na doménových jménech a èasových razítkách. Proto IPA
slou¾í také jako DNS a NTP\footnote{Network Time Protocol} server.\cite[p. 17,
Chapter 1]{Identity_Management_Guide}

Pro cíle této bakaláøské práce nás dále bude zajímat pouze správa sudo politik.
Tedy jakým zpùsobem IPA server sudo pravidla uchovává a jak jsou zpracovány
na stranì klienta démonem SSSD.

\begin{itemize}
	\item popsat ¾e memberAllowCmd bude v¾dy pøed memberDenyCmd
	\item	popsat IPA SUDO Schéma a srovnat ho s LDAP SUDO Schématem
	\item	napi¹ to tak jako by SSSD zpracovávalo ty pravidla z cn=sudo,\$DC,
		detaily u IPA SUDO providera ve stylu tohle není tak úplnì pravda, detaily
		je mo¾né nalézt v sekci ...
		\ref{ch:sssd:sec:ipa_provider} 
	\begin{itemize}
		\item ka¾dé záznam i kontejner v sudo kontejneru má operaèní atribut
			entryUSN, vèetnì sudo kontejneru samotného\cite[Chapter 2]{Redhat_Directory_Server_Schema_Reference}
\cite{Redhat_Directory_Server_Administration_Guide}
		\item zmínit, ¾e sudo pravidla jsou umístìna ve 3 kontejnérech
	\end{itemize}
\end{itemize}

Identity Management uses its centralized LDAP database to contain the sudo
configuration, which makes it globally available to all domain hosts. Identity
Management also has a specialized LDAP schema for sudo entries that allows a lot
more flexible and simpler configuration. This schema adds two key features: 

\begin{itemize}
	\item The Identity Management schema supports host groups in addition to
		netgroups for sudo, while sudo only supports netgroups.  For every host
		group, Identity Management also creates a corresponding shadow netgroup. T
		his allows IdM administrators to create sudo rules that reference host
		groups, while the local sudo command uses the corresponding netgroup.  
	\item Identity Management introduces the concept of a sudo command group. T he
		group contains multiple commands, and the command group can be referenced in
		the sudo configuration.  Because sudo does not support host groups and
		command groups, Identity Management translates the IdM sudo configuration
		into native sudo configuration when the sudo rules are created.\cite{Identity_Management_Guide}
\end{itemize}

\subsubsection{USN plugin}\label{theory:usn_plugin}
Tento plugin poskytuje zpùsob, který umo¾òuje informovat IPA klienty o
\textbf{modifikaci} jakéhokoliv záznamu
\cite[s.~130, Sekce: Tracking Modifications to Directory Entries]{Redhat_Directory_Server_Administration_Guide}.  Ka¾dý záznam na IPA
serveru má operaèní atribut entryUSN\footnote{Entry Update Sequence Number}.
Hodnotu tohoto atributu aktualizuje USN plugin pøi ka¾dé zmìnì daného záznamu.

%-------------------------------------------------------------------------------
\section{SSSD z u¾ivatelského hlediska}
\begin{itemize}
	\item vysvìtlit, ¾e s SSSD mù¾e¹ být pøipojen do více domén zároveò, tak¾e
		mù¾e¹ tahat sudo pravidla z více serverù? A jak se potom ten jiny server
		nastavuje?? to je asi nìjaká kravina ne? a nebo mohou byt pravidla pouze ve
		dvou konteinerech?\label{multiple_domains}
	\item udìlej takový lehký uvod jako tady,
		$http://docs.fedoraproject.org/en-US/Fedora/16/pdf/System_Administrators_Guide/Fedora-16-System_Administrators_Guide-en-US.pdf$
	\item koukni do README sssd je tam dobry kratky popis co to je ...
	\item v¹e o SSSD z u¾ivatelského hlediska, implementaèní detaily v kapitole
		\ref{ch:sssd}
	\item obrázek (user -> sudo -> SSSD -> IPA)
	\item co to je a krátce co to v¹echno umí
	\item vymezení oblast, kterou se tato práce bude zabývat
	\item da se pøipojit k více doménám zároveò a tedy prohledávám více search
		bases (dát to a¾ do kapitoly SSSD?)
	\item nevýhody, které má øe¹ení stahování pravidel pøes sudo LDAP plugin
	\begin{itemize}
		\item sí»
		\item cachování (pou¾ívá se LDB\footnote{http://ldb.samba.org/})
	\end{itemize}
\end{itemize}

\subsection{Aktualizace sudo pravidel v cache pamìti}
SSSD provádí následující tøi typy aktualizací sudo pravidel:

\subsubsection{Prùbì¾né aktualizace}
Periodicky stahují pravidla, která jsou na serveru novì pøidány nebo byly od
posldní aktualizace modifikovány. V manuálnových stránkách a v kódu SSSD je
mo¾né tento typ aktualice najít jako "\textit{smart refresh}".

\subsubsection{Úplná aktualizace}
Provede smazání v¹ech pravidel z cache pamìti a sta¾ení v¹ech pravidel ze serveru.
Tento typ aktualizace se neprovádí velmi èasto, proto¾e pøi velkém mno¾ství
pravidel generuje velký sí»ový provoz. Provádí se tedy pouze pøi spu¹tìní SSSD nebo
pøi detekci zmìny pravidel na serveru. Je také s velkým èasovým odstupem
plánován. V manuálnových stránkách a v kódu SSSD je
mo¾né tento typ aktualice najít jako "\textit{full refresh}".

\subsubsection{Aktualizace pravidel}
Je provedena pøi ka¾dém spu¹tìní sudo. Zajistí aby u¾ivatel nedostal vìt¹í
oprávnìní ne¾ je definováno. Tento typ aktualizace stáhne ze serveru pouze
pravidla, která expirovala\footnote{Èas po kterém pravidla v cache pamìti exspirují je mo¾no
nastavit v \texttt{sssd.conf} pomocí volby \texttt{entry\_cache\_sudo\_timeout}, viz.
\emph{man sssd.conf}}. Jestli¾e se nìkteré pravidlo na serveru
nenachází, indikuje to zmìnu na serveru a je provedena úplna aktualizace
pravidel. V manuálnových stránkách a v kódu SSSD je mo¾né tento typ aktualice
najít jako "\textit{rules refresh}". 

\subsection{Konfiguraèní volby}\label{ch:theory:sec:sssd:sssd_sudo_options}
\subsubsection{Plánování aktualizací}
\label{ch:theory:sec:sssd:sssd_ldap_options:refreshes}
Jak èasto budou provádìny prùbì¾né a úplné aktualizace je mo¾né ovlivnit
pomocí následující voleb:
\begin{itemize}
	\item \texttt{ldap\_sudo\_smart\_refresh\_interval}
	\item \texttt{ldap\_sudo\_full\_refresh\_interval}
\end{itemize}
	
\subsubsection{Modifikace LDAP schématu}\label{ch:theory:sec:sssd:sssd_ldap_options}
\begin{itemize}
	\item pokud chci mít sudo v LDAPu v sudo schématu, pak atributy v LDAPu musí
		mít jasnì specifikované jména (\texttt{sudoHost, sudoCmd}, \dots) u SSSD to lze
		ovlivnit pomocí voleb \texttt{ldap\_sudorule\_object\_class,
		ldap\_sudorule\_name, \dots}\footnote{Pro bli¾¹í informace hledejte
		\texttt{ldap\_sudorule\_*} v manuálové stránce \texttt{man sssd-ldap}}.
		Implementaèní detaily je mo¾né nalézt v sekci 
		\ref{ch:sssd:sec:ldap_provider:native_sudorule_map}.
\end{itemize}
	
\begin{itemize}
	\item sssd volby pro sssd.conf
	\begin{itemize}
		\item ldap\_sudo\_use\_host\_filter
	\end{itemize}
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 3. SSSD
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{SSSD a SUDO provider}\label{ch:sssd}
Tato kapitola popisuje vnitøní architekturu démona SSSD se zamìøením na sudo
providera a pluginy, které má k dispozici. Tento popis byl sestaven na základì
experimentování a ètení zdrojových kódù. Popis byl nezbytný pro úplné
pochopení zpùsobu, jakým SSSD zpracovává sudo pravidla.
Vysvìtluje také základní koncepty knihoven talloc
a tevent na kterých SSSD staví a jejich pochopení bylo nezbytné jak pro
porozumìní ji¾ implementováného kódu, tak pro návrh a implementaci nového
providera.

%-------------------------------------------------------------------------------
\section{Talloc}
literatura: \cite{talloc}
\begin{itemize}
	\item asi budu muset zmínit kontexty ...
	\item	základní concept hierarchického alokátoru
	\item	nahrazuje malloc
\end{itemize}

\section {Tevent}
literatura: \cite{tevent}
\begin{itemize}
	\item	definovat co je to \textbf{callback} a vysvìtlit, ¾e ne¾ se zavolá, tak
		tam probíhá asynchronní zpracování
	\item	událostmi øízené paradigm programování
	\item	vysvìtlit základní concept událostí, requests, subrequest, asynchronní funkce
	\item	pou¾ívá talloc
	\item	zmínit ¾e obaluje DBus a OpenLDAP (SDAP)
\end{itemize}

\section {Architektura SSSD}\label{sssd:architecture}

\begin{figure}[ht!]
	\centering
	\includegraphics[width=120mm]{fig/sssd/sssd_architecture.jpg}
	\caption{Architektura SSSD}
	\label{sssd_architecture}
\end{figure}

SSSD se skládá z nìkolika komponent, jejich¾ souhrnnou èinnost demonstruje schéma
\ref{sssd_architecture}. Hlavním procesem je \textit{Monitor}, který je otcem v¹ech ostatních procesù. Stará se o to, aby
ostatní procesy zùstaly aktivní. Detekuje sí»ové zmìny a informuje o nich
ostatní procesy. 

Dal¹í komponentou jsou \textit{respondeøi}. Jsou to procesy, které pøijímají po¾adavky od klientských
aplikací\footnote{napø.  sudo, id, getent, ls, \dots} a vracejí odpovìdi na tyto
po¾adavky. Smyslem tìchto procesù je vrátit co nejrychleji odpovìd na dotaz,
který jím klientská aplikace\footnote{napøíklad sudo, ls nebo getent} zaslala.
Proto by mìly provádìt co nejménì algoritmicky nároèných operací a vpodstatì
pouze èist a s pøedávát data z cache pamìti SSSD. Ve¹kerou práci spojenou s
komunikací se zvdáleným serverem, zpracování výsledkù a jejich ulo¾ení do cache
pamìti by mìl zajistit pou¾itý plugin. Komunikují tedy pouze s cache pamìtí nebo poskytovali dat, ale nikdy
nekomunikují se vzdáleným serverem. V následujícím textu bude pro ka¾dý
takvovýto proces pou¾íván výraz \textbf{responder}.

Dal¹í komponentou je poskytovatel dat\footnote{v angliètinì se pou¾ívájí výrazy
"Data Provider" nebo "Backend"}. Tento proces reprezentuje
jednu doménu. Jestli-¾e je klient pøipojen k více doménám zároveò, pak je tento
proces vytvoøen pro ka¾dou doménu zvlá¹».  Jeho úlohou je mimo jiné zpracovávání
po¾adavku od responderù, komunikace se vzdálenými servery a aktualizace sysdb.

Ke komunikaci se servery pou¾ívá ka¾dý typ providera\footnote{id\_provider,
sudo\_provider}pluginy providerù\footnote{Providers
Plugins}. Které pluginy pro dané providery má SSSD pou¾ít je mo¾no specifikovat
v konfiguraèním souboru \texttt{sssd.conf}. Mezi providery patøí napø.
\texttt{id\_provider} specifikující, který plugin se má pou¾ít pro pøístup k
identitám, nebo  \texttt{sudo\_provider}  specifikující, který
plugin\footnote{oznaèované také jako "Backend Modules} se má pou¾ít pro pøístup
k sudo pravidlù. Kde jsou dané identity nebo sudo pravidla ulo¾eny musí být poté
dále specifikováno. Typy providerù a pluginù, které je mo¾né pro tyto providery
pou¾ít spoleènì s dal¹ími konfiguraèními volbami je mo¾né nalézt v manuálové
stránce \texttt{man sssd.conf}.Pøipojení do více domén zároveò, pou¾ítí typù
providerù a jejich pluginù znároznùje schéma \ref{fig:sssd_multiple_domains} Pro
oznaèení této komponenty bude dále v textu pou¾íván výraz \textbf{backend}.

\begin{figure}[ht!]
\centering
\includegraphics[width=120mm]{fig/sssd/sssd_multiple_domains.png}
\caption{Pøipojení k více doménám zároveò}
\label{fig:sssd_multiple_domains}
\end{figure}

\label{sssd:bet_info}
Ka¾dý backend má ve svém kontextu\footnote{\texttt{struct be\_ctx}} ukazatel na
pole \texttt{bet\_info}, které obsahuje informace o providerech, které daný
backend pou¾ívá. Ka¾dá polo¾ka tohoto pole je tvoøena strukturou
\texttt{bet\_info}. Ta obsahuje napø. jméno pluginu, který se má pro daný
provider pou¾ít, ukazatel na privátní data nebo ukazatel na strukturu
\texttt{bet\_ops}, kde se nachází ukazatel na funkci, kterou volají respondeøi,
pokud chtìjí danému pluginu zaslat po¾adavek. Jméno této funkce má v SSSD obecnì
pøíponu \textbf{handler}\footnote{napøíklad \texttt{sdap\_sudo\_handler} je
SUDO handler pro LDAP SUDO Plugin} a takto bude oznaèována v následujícím textu.
Polo¾ku pole \texttt{bet\_info} pro LDAP SUDO providera zobrazuje obrázek
\ref{fig:bet_info_sudo}.

\begin{figure}[ht!]
\centering
\includegraphics[width=150mm]{fig/sssd/bet_info_sudo.png}
\caption{Polo¾ka pole \texttt{bet\_info} pro SUDO}
\label{fig:bet_info_sudo}
\end{figure}


\subsection{Sysdb}\label{sysdb}
Ka¾dý backend pou¾ívá svou cache pamìt, která je tvoøena LDB databází. Do této
pamìti zapisuje pouze daný backend a data z ní ètou respondeøi. V následujícím
textu bude pro tuto pamìt obecnì pou¾íván název \textbf{sysdb}.

\section {Tok dat}
\begin{itemize}
	\item	tok dat do SUDO -> SUDO Responder -> Backend -> LDAP Provider -> IPA a zpìt
	\item big diagram - nerozkrývat detaily respondera a providera
\end{itemize}

\subsection{SDAP dotaz a mapování atributù}\label{sdap}
Jestli¾e se administrátor rozhodne ulo¾it sudo pravidla do LDAP adresáøe, musí
dodr¾et sudem specifikované schéma. Tedy pøesná jména atributù a formát hodnot.
Pravidla v jiném formátu sudo zpracovat neumí\footnote{Neumí zpracovat ani
pravidla v IPA SUDO schématu, který pou¾ívá IPA server, viz. sekce
\ref{ch:sssd:sec:ipa_provider}}. S pomocí SSSD je mo¾né ovlivnit alespoò názvy
atributù pod kterými jsou sudo pravidla ulo¾ena. Toho je docíleno za pou¾ití
map.

Mapy se pou¾ívají k mapování hodnot voleb\footnote{viz. sekce
\ref{ch:theory:sec:sssd:sssd_sudo_options}} z konfiguraèního souboru
SSSD\footnote{Ve výchozím nastavení se nachází v \texttt{/etc/sssd/sssd.conf} },
pro výbìr atributù pøi sestavování LDAP dotazu a pro definování jmen atributù
pod kterými budou výsledky dotazù ulo¾eny v sysdb. 
Výchozí mapy jsou definovány v hlavièkovém souboru \texttt{providers/ldap/ldap\_opts.h}. Zde
je také definována výchozí mapa, kterou LDAP SUDO Provider pou¾ívá pøi stahování
sudo pravidel z LDAP serveru.  
Mapy pou¾ívané pøi komunikace s IPA serverem se
nacházejí v souboru \texttt{providers/ipa/ipa\_opts.h}.

Vìt¹ina map je definována jako pole následujících struktur.

\lstset{language=c}
\begin{lstlisting}
struct sdap_attr_map {
    const char *opt_name;
    const char *def_name;
    const char *sys_name;
    char *name;
};
\end{lstlisting}

Mapu je mo¾né vytvoøit pomocí funkce \texttt{sdap\_get\_map()}. Jako jeden z
parametrù je nutné specifikovat výchozí mapu, ze které bude mapa vytvoøena. V
promìnných \texttt{opt\_name} jsou ulo¾eny jména voleb z konfiguraèního
souboru, jejich¾ hodnoty se ulo¾í do promìnných \texttt{name}, pokud byly v
sssd.conf specifikovýny.  Jestli¾e se daná
volba v konfiguraèním souboru nenachází, pak je pro promìnnou \texttt{name}
pou¾ita výchozí hodnota tj. hodnota prommìné \texttt{def\_name}, která bude
specifikována ve výchozí mapì.  Hodnoty promìnných \texttt{name} jsou pou¾ity
pøi vytváøení atributù, které se mají vyhledat pøi LDAP dotazech. Promìnná
\texttt{sys\_name} je pou¾ita pro jméno atributu, pod kterým bude ulo¾ena
hodnota, která se nachází na serveru pod hledaným atributem, v \texttt{sysdb}.
Ukázka z v výchozí mapy kterou pou¾ivá sudo vypadá následovnì:
\\\\
\texttt{\{"ldap\_sudorule\_user", "sudoUser", "sudoUser", NULL\},}
\\\\
Z této ukázky je mo¾no odvodit, ¾e jestli¾e není v \texttt{sssd.conf} zadaná
volba \texttt{ldap\_sudorule\_user}. Pak bude pøi sestavování LDAP dotazu na
sudo pravidelo po¾ádován atribut \texttt{sudoUser} a do sysdb bude jeho hodnota
rovnì¾ ulo¾ena pod jménem atributu \texttt{sudoUser}.

Uva¾ujme následující pøíklad, který demonstruje schéma \ref{map_usage_example}.
V \texttt{sssd.conf} se nachází následující volba: 

\lstset{language=bash}
\begin{lstlisting}
ldap_sudorule_user = my_sudo_user_attr
\end{lstlisting}

\begin{figure}[H]
	\centering
	\includegraphics[scale=1.00]{fig/sssd/map_usage_example.pdf}
	\caption{Ukázka mapování atributù z \texttt{sssd.conf} do sysdb}
	\label{map_usage_example}
\end{figure}

{\color{red}{TODO: je¹tì toho sudoUser zvýrazni modøe a» je to z toho jasné}}
Jméno u¾ivatele na kterého bude aplikováno sudo pravidlo bude hledán pod názvem
atributu \texttt{my\_sudo\_user\_attr} a do sysdb budou ulo¾eny pod atribut
\texttt{sudoUser}.

Asynchronní volání \texttt{ldap\_search\_ext()} samozdøejmì neumo¾òuje ¾ádnou
mapu specifikovat. SDAP\footnote{Tevent wrapper of OpenLDAP library} definuje
vlastní asynchronní rozhraní \texttt{sdap\_get\_generic\_ext\_send}, které s
tìmito mapami pracuje. Toto rozhraní také provádí zpracování výsledkù, které
vrací funkce knihovny OpenLDAP, a vrací je jako elementy LDB knihovny. Zde je
nezbytné zminit, ¾e jako první polo¾kou v mapì musí být \textbf{v¾dy}
specifikována \textbf{objectClass}.  Pøijaté záznamy, které neodpovídají této
tøídì nebudou pøedány jako výsledek!  Takté¾ v mapì není mo¾né specifikovat více
ne¾ jednu mapu! Výsledky \texttt{ldap\_search\_ext} a
\texttt{sdap\_get\_generic\_ext\_send}, který je postaven nad OpenLDAP, tedy
nemusejí být v¾dy ekvivalentní.

SDAP je¹tì nabízí druhé rozhraní a to \texttt{sdap\_deref\_search\_send}. Pomocí
kterého je mo¾né získat záznam a také v¹echny záznamy na které je ze
záznamu odkazováno pomocí DN.  U toho dotazu ov¹em není mo¾né specifikovat
filtr, jeliko¾ mohu provést dereferenci atributù pouze \textbf{jednoho} záznamu!
Obrázek \ref{sdap_deref} zobrazuje zánamy, které by byly vráceny po zaslání
dereferenèního dotazu pro záznam jeho¾ DN je
\texttt{fqdn=client1.example.cz,cn=comput}
\texttt{ers,cn=accounts,\$DC}

\begin{figure}[H]
	\centering
	\includegraphics[scale=1.00]{fig/sssd/deref_example.pdf}
	\caption{Ukázka dereferenèního dotazu}
	\label{sdap_deref}
\end{figure}


%================================================
\section {SUDO Responder}
Pøi ka¾dém zavolání sudo se SSSD SUDO responder nejprve podíva do cache pamìti. 
\begin{itemize}
	\item	Pøidat podrobnìj¹í popis
\end{itemize}

%-------------------------------------------------------------------------------
\section {LDAP SUDO Provider}
Tento plugin provádí ve¹kerou práci pøi komunikaci s IPA serverem na kterém jsou
ulo¾ena sudo pravidla. Sta¾ení, zpracování a ulo¾ení tìchto pravidel do sysdb.
Plugin se skládá z nìkolika modulù jejich¾ celkovou funkcionalitu
popisuje schéma \ref{ldap_provider_high_level}.

\begin{figure}[ht!]
\centering
\includegraphics[width=220mm,angle=270]{fig/scan/ldap_provider_basic_concept.jpg}
\caption{High level overview of LDAP SUDO Provider}
\label{ldap_provider_high_level}
\end{figure}

\subsection {Inicializace}\label{ldap_sudo_provider_initialization}
Inicializaci zaji¹tuje modul \texttt{providers/ldap/sdap\_sudo.c} a probíhají
pøi ní následující ulohy:
\begin{itemize}
	\item alokace \texttt{sudo\_ctx} kontextu, který je zároveò privátnimi daty LDAP SUDO
			Providera
		\item nastavení handleru pro SUDO respodera, tj. vytvoøení struktury
			\texttt{bet\_ops}
	\item vytvoøení mapy z výchozí \texttt{native\_sudorule\_map} mapy
	\item získání v¹ech jmen a IP adres daného poèítaèe
	\item nastavení plánování aktualizací sudo pravidel
\end{itemize}
	
Inicializace zaèíná ve funkci \texttt{sdap\_sudo\_init}, které je pøedán
\texttt{id\_ctx}. Zde je mo¾né nalézt napø.
\texttt{sudo\_search\_base}\footnote{\texttt{id\_ctx->basic[SDAP\_SUDO\_SEARCH\_BASE]}},
	ukazatel na nativní SUDO mapu\footnote{\texttt{id\_ctx->sudorule\_map}} nebo ukzatal na doménu, kde je mo¾né nalézt pole
	v¹ech search\_sudo\_base\footnote{\texttt{id\_ctx->sdom->sudo\_search\_bases}}, které SSSD aktuálnì pou¾ívá.

Vytváøí se zde také sudorule mapa. Jako výchozí mapa je pou¾ita
\texttt{native\_sudorule\_map} a pøi vytváøení se také zohledòují volby (viz.
sekce \ref{ch:theory:sec:sssd:sssd_ldap_options}) zadané v konfiguraèním souboru
SSSD. Ukazatel na vytvoøenou mapu je ulo¾en v \texttt{id\_ctx}\footnote{Kontext
providera identit (angl.  Context of Identity Provider}. Vytvoøení a pou¾ití map
je blí¾e popsáno v sekci \ref{maps}.

Jména poèítaèe, pro která budou stahována aplikovatelná sudo pravidla, jsou 
získávána automaticky pomocí systémového volání \texttt{gethostname()}. Jestli-¾e je ji¾ jméno
poèítaèe specifikováno jako FQDN. Pak ji¾ dal¹í vyhledávání neprobíhá. V opaèném
pøípadì se LDAP plugin pokusí získat FQDN pomocí asynchronního volání
\texttt{resolv\_gethostbyname\_send()}. I kdy¾ jsou IP adresy a jméno poèítaèe
získávána automaticky, je mo¾né je specifikovat pøímo v \texttt{sssd.conf} pod
volbami \texttt{ldap\_sudo\_hostnames} a \texttt{ldap\_sudo\_ip}. Jejich hodnoty
jsou poté zohlednìny pøi sestavovaní filtrù pro LDAP dotazy. Pou¾itím tìchto
voleb je poté mo¾né stahovat i taková sudo pravidla, která nejsou aplikovatelná
na klientský poèítaè\footnote{Pou¾íváno pøevá¾nì pro testování}. 


\subsection {Plánování aktualizací}\label{ldap_sudo_refresh_scheduling}
Souèástí inicializace je také nastavení plánování prùbì¾ných a úplných
aktualizací. Jak èasto budou tyto aktualizace provádìny je mo¾né ovlivnit 
v \texttt{sssd.conf}, viz sekce 
\ref{ch:theory:sec:sssd:sssd_ldap_options:refreshes}.

Pøi spou¹tìní SSSD by mohla nastat situace, kdy stihne u¾ivatel zavolat sudo
je¹tì pøed provedením aktualizace. V takovém pøípadì by sudo nefungovalo
správnì,
jeliko¾ by se v sysdb nenacházela ¾ádná pravidla.\footnote{za pøedpokladu, ¾e se 
na serveru nìjaká pravidla nacházejí} Proto je pøi ka¾dém spu¹tìní SSSD
provedena kompletní aktualizace sudo pravidel.

Plánování aktualizací je realizováno pomocí èasových událostí knihovny tevent a
implementaèní detail je mo¾né nalézt ve funkci
\texttt{sdap\_sudo\_setup\_periodical\_refresh}

\subsection{Aktualizace sudo pravidel}
V¹echny tøi typy aktualizací vyu¾ívají modul
\texttt{providers/ldap/sdap\_async\_sudo.c}, který provádí samotné sta¾ení a
ulo¾ení sudo pravidel do sysdb. Funkcionalitu tohoto modulu je mo¾né ovlivnit
pomocí parametrù, které jsou mu pøedány. Parametry mohou být napøíklad filtry,
které se mají pou¾ít. Pøedpøipravení parametrù pro konktrétní aktualizace
provádìjí následující funkce: 
\begin{itemize} 
	\item \texttt{sdap\_sudo\_full\_refresh\_send} pro kompletní aktualizaci 
	\item \texttt{sdap\_sudo\_smart\_refresh\_send} pro prùbì¾né aktualizace 
	\item \texttt{sdap\_sudo\_rules\_refresh\_send} pro aktualizaci pravidel 
\end{itemize}

\subsubsection{Úplná aktualizace}
\label{ch:sssd:sec:ldap_provider:full_refresh_implementation}
Pro úplnou aktualizaci sudo pravidlel je pou¾it následující LDAP
filter. Tento i v¹echny následující filtry se øídí syntaxí specifikovaou v
\cite[RFC2254]{rfc2254}.  Jsou pouze doplnìny bílými znaky pro lep¹í èitelnost.

\lstinputlisting{DVD/ldap_filters/ldap_sudo_provider/full_refresh_filter}
(objectClass=sudoRule)
Tento filter vyhledá v¹echna sudo pravidla, která jsou aplikovatelná na
klientský poèítaè. Jméno poèítaèe (\texttt{hostname} a \texttt{hostname.domain})
a IP adresy jsou získány pøi inicializaci. Filtr také zachytí v¹echna pravidla
aplikovatelná na jakoukoliv sí»ovou skupinu\footnote{netgroup} poèítaèù
(\texttt{(sudoHost=+*)}, proto¾e nemá informaci o tom, ve kterých sí»ových
skupinách se poèítaè nachází.

Pøed ulo¾ením sta¾ených pravidel jsou nejprve z sysdb odstranìny \textbf{v¹echny} sudo
pravidla pomocí filtru \texttt{(objectClass=sudoRule)}. A¾ poté je zahájena
transakce pro ulo¾ení novì sta¾ených pravidel.

\subsubsection {Prùbì¾ná aktualizace}
\label{ch:sssd:sec:ldap_provider:smart_refresh_implementation}
Pro detekci modifikovaných pravidel se pøi prùbì¾ných aktualizacích vyu¾ívá USN
plugin a jeho \texttt{EntryUSN} atribut, viz. sekce \ref{theory:usn_plugin}.

Pøedpokládejme pøíklad kdy je na klientském poèièi spu¹tìno SSSD a má
následující parametry: 

\begin{table}[H]
	\begin{tabular}{ll}
	Doménové jméno: & \texttt{client1.example.cz} \\
	IPv4 adresa:    & \texttt{192.168.0.2} \\
	IPv6 adresa: 		& \texttt{fe80::a00:27ff:fe71:1191} \\
	\end{tabular}
\end{table}


V sysdb ji¾ máme sta¾ená nìjaká pravidla a nejvy¹¹í hodnota \texttt{EntryUSN},
která se mezi pravidly nachází je \textbf{9270}. Filtr, který by se pou¾il pøi
prùbì¾né aktualizaci by vypadal následovnì:

\lstinputlisting{DVD/ldap_filters/ldap_sudo_provider/smart_refresh_filter}

Pøi prùbì¾ných aktualizacích z sysdb nejsou mazána ¾ádná pravidla. Dochází pouze
k pøidávání pravidel, jestli¾e se na serveru vyskytují novìj¹í pravidla.

\subsubsection {Aktualizace pravidel}\label{ch:sssd:sec:ldap_provider:rules_refresh_implementation}
Jestli¾e se v sysdb pøi spu¹tìní sudo nachází nìjaká pravidla, která ji¾ nejsou
platná, pak se provede jejich aktualizace. Pøedpokládejme pøíklad, kdy v sysdb
expirovala pravidla \textbf{rule1} a \textbf{rule2}. Poté by LDAP a sysdb filtr pro jejich
aktualizaci vypadal následovnì:

\lstinputlisting{DVD/ldap_filters/ldap_sudo_provider/rules_refresh_filter}

Aktualizace pravidlel, která jsou stále platná se neprovede. Neprovede se ani
aktualizace právì vyvolaného pravidla, za pøedpokladu, je stále platné.


\subsection {Asynchronní modul}\label{async_engine_of_ldap_provider}
{\color{red}{TODO: popsat souvislost mezi tìmi dvìmi schématy!}}
{\color{red}{TODO: tady popsat jak ze zpracují ty zázamy z LDAPu, jak se pou¾ívá
mapa a jejich formát ...}}
{\color{red}{TODO: popsat tady jen ten formát a mapu a to zpracovaní pravidel do
separátní sekce o SDAPu???}}

Modul \texttt{providers/ldap/sdap\_async\_sudo.c} je nejdùle¾itìj¹í èástí LDAP
SUDO pluginu, který provádí asynchronní sta¾ení a ulo¾ení sudo pravidel do
sysdb. Jeho èinnost popisuje schéma \ref{fig:ldap_sudo_provider_tevent_flow}. 

Ve funkci \texttt{sdap\_sudo\_refresh\_retry} probìhne kontrola zda je backend
stále online. Tedy kontrola zda je klient stále pøipojen k síti.
Jestli¾e ano, pak probìhne inicializace LDAP spojení. Ve funkci
\texttt{sdap\_sudo\_load\_sudoers\_send} se vytváøí pole atributù pro LDAP
dotaz. Funkce \texttt{sdap\_sudo\_load\_sudoers\_next\_base} nastavuje aktuální
search base, a posílá LDAP dotaz pomocí rozhraní
\texttt{sdap\_get\_generic\_send}. Pøijmutí a zpracování pravidel, tj. pøidání
pravidel k ji¾ sta¾eným, provádí funkce
\texttt{sdap\_sudo\_load\_sudoers\_process}. Jakmile jsou v¹echna pravidla
sta¾ena, probìhne modifikace sysdb a poté je zahájena transakce pøi které se
novì sta¾ená pravidla ulo¾í do sysdb.

\begin{sidewaysfigure}
	\centering
	%\includegraphics[scale=0.90]{fig/sssd/ldap_sudo_provider/ldap_sudo_provider_tevent_flow.pdf}
	\includegraphics[scale=0.90]{fig/sssd/ldap_sudo_provider/ipa_sudo_provider_tevent_flow.pdf}
	\caption{Schéma událostí asynchroního modulu \texttt{providers/ldap/sdap\_async\_sudo.c}}
	\label{fig:ldap_sudo_provider_tevent_flow}
\end{sidewaysfigure}

\subsection {Ulo¾ení sudo pravidel do sysdb}
Pøed samotným ulo¾ením pravidel jsou v sysdb nejprve vyhledány a následnì
odstranìny v¹echny záznamy, které odpovídají danému filtru.  Pøi
ukládání sudo pravidel se ka¾dému pravidlu pøidá atribut
\mbox{\textbf{dataExpireTimestamp}}\footnote{aktuální èas (v dobì ukládání) +
hodnota volby \texttt{entry\_cache\_sudo\_timeout}, viz. man
\texttt{sssd.conf}}. Jeho hodnota reprezentuje èas, kdy daný záznam expiruje,
tj.  stane se neplatným. Zároveò je získána nejvy¹¹í hodnota USN, která ov¹em
není ulo¾ena v cache pamìti spoleènì s pravidly, ale v kontextu
\texttt{id\_ctx->srv\_opts} v promìnné \texttt{max\_sudo\_value}\footnote{?ta se
potom vyu¾ívá u SMART refresh?}.

\subsection {LDAP SUDO Handler}
Jestli¾e SUDO responder nenajde daná pravidla v sysdb, pak za¹le
SBUS\footnote{DBUS wrapper integrující knihovnu tevent} po¾adavek pøes SUDO
handler danému providerovi.  Jestli¾e SUDO pou¾ívá LDAP jako provider plugin
\footnote{\texttt{sudo\_provider=ldap}}, pak se zavolá handler
\texttt{sdap\_sudo\_handler}. Handler se nachází v kontextu backendu, viz. sekce
\ref{sssd:bet_info}. Samotnou definici handleru je mo¾né najít v modulu
\texttt{sdap\_sudo.c}.

LDAP SUDO provideru je pøes handler pøedán typ aktualizace, který po nìm SUDO
respoder ¾ádá a pole pravidel\footnote{pole jmen pravidel, tj. pole hodnot
\texttt{cn} atributù}. SUDO responder mù¾e po¾ádat o úplnou aktualizaci
pravidel nebo o aktualizaci pravidel, která ji¾ v sysdb nejsou nadále platná.

\begin{figure}[H]
\centering
\includegraphics{fig/sssd/ldap_sudo_provider/ldap_sudo_handler.pdf}
\caption{LDAP SUDO Handler}
\label{ldap_sudo_handler}
\end{figure}
%-------------------------------------------------------------------------------

\section {IPA SUDO provider}\label{ch:sssd:sec:ipa_provider}
Pro SUDO providera je mo¾né pou¾ít také ipa
plugin\footnote{\texttt{sudo\_provider=ipa}}, jestli¾e jsou sudo pravidla
ulo¾ena na IPA serveru.  Problém ov¹em je, ¾e SSSD nedisponuje IPA pluginem pro
sudo providera, který by podporoval IPA SUDO schéma. Souèasná implementace
tohoto pluginu je pouze wrapper pro LDAP sudo plugin. Samotný LDAP plugin rovnì¾
nepodporuje IPA SUDO schéma a neumí tedy sudo pravidla v tomto formátu zpracovat
.  LDAP plugin umí zpracovat pouze pravidla, která odpovídají nativnímu LDAP
SUDO schématu. 

\begin{figure}[H]
	\centering
	\includegraphics{fig/sssd/ipa_sudo_provider/ipa_sudo_wrapper.pdf}
	\caption{Souèasná implementace IPA SUDO pluginu}
	\label{ipa_sudo_provider_wrapper}
\end{figure}

Pro podporu sudo pravidel v IPA SUDO formátu vyu¾ívá souèasná implementace SSSD
\textit{compat plugin}. Tento plugin bì¾í na serveru FreeIPA a zaji¹tuje pøeklad
sudo pravidel z IPA SUDO schématu do LDAP SUDO schématu. Funkcionalitu pluginu
demostruje schéma \ref{sudo_rules_compat_plugin}. Pøeklad samotný 
probíhá pøi ka¾dém vytvoøení nebo modifikaci sudo pravidla. Takto
pøelo¾ená pravidla se poté na serveru nacházejí v kontejneru
\texttt{ou=SUDOers,\$DC}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.98]{fig/sssd/ipa_sudo_provider/compat_plugin_example.pdf}
	\caption{Pøeklad sudo pravidel provádí na IPA serveru compat plugin}
	\label{sudo_rules_compat_plugin}
\end{figure}

{\color{red}{TODO: fig: dics => disc}}

Sudo pravidla jsou tedy na serveru ulo¾ena dvakrát, i kdy¾ v jiných schématech.
Za pøedpokladu, ¾e by SSSD mìlo podporu pro nativní IPA SUDO schéma, byla by
odstranìna re¾ie compat pluginu. To znamená, ¾e by nadále nebylo nutné
provádìt pøeklad \textbf{v¹ech} sudo pravidel. Pøeklad by byl pøenesen ze
serveru na klienta. To by znamenalo pøeklad pouze tìch pravidel,
která jsou aplikovatelná pro daného klienta. 

Tato bakaláøská práce si klade za cíl odstranìní této re¾ie a implementaci ipa
sudo pluginu, který bude zaji¹tovat podporu nativního IPA SUDO schématu.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 4. Nativní IPA SUDO Provider
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Nativní IPA SUDO Provider}
Tato kapitola se zabývá diskusí nad øe¹ením hlavních problémù, které je nutno
zvá¾it pøi návrhu, implementaci a testování nativního IPA SUDO providera. Návrh
popisuje mo¾né pøístupy ke sta¾ení a zpracování sudo pravidel, jejich¾ výhody a
nevýhody byly diskutovány s vývojáøi LDAP SUDO providera. Nìkteré specifické
detaily také s vývojáøi projektu FreeIPA. Sekce implementace popisuje jak a
které z tìchto pøístupù byly vybrány pro implementaci nového providera. V sekci
testování je poté popsána metodika a nástroje vyu¾ité k otestování navr¾ených
øe¹ení.

\section{Návrh}
\subsection{Sudo pravidla aplikovatelná na klienta}
Jedním z problémù, které je nutno vyøe¹it, je správný pøístup k tomu jakým
zpùsobem získat kompletní sudo pravidla pro daný poèítaè. A zároveò nestahovat
¾ádná pravidla ani jiné nepotøebné informace navíc. LDAP sudo provider pøi úplné
aktualizaci stahuje napøíklad i v¹echna pravidla, která jsou aplikovatelná na
libovolnou sí»ovou skupinu poèítaèù. Ke stahování pravidel z IPA serveru lze
pøistoupit následujícími zpùsoby.

\subsubsection{Klient jako èlen IPA domény}
Ka¾dý klientský poèítaè, který je èlenem IPA domény má na IPA serveru záznam v kontejneru
\texttt{cn=computers,cn=accounts,\$DC}. Ka¾dý takový záznam obsahuje napøíklad atribut
\texttt{memberOf}, kde se nacházejí odkazy na záznamy skupin poèítaèù, sí»ových
skupin a sudo nebo HBAC\footnote{Host-Based Access Control} pravidel, kterými je
daný poèítaè èlenem. Bylo by tedy mo¾né jedním dotazem získat odkazy na sudo
pravidla, která jsou aplikovatelná na daný klientský poèítaè a dal¹ími dotazy u¾
konkrétní záznamy sudo pravidel.  Jestli-¾e bychom chtìli získat
\texttt{DNs}\footnote{Distinguished Names} sudo pravidel aplikovatelných na
klientský poèítaè jeho¾ doménové jméno je \texttt{client1.example.cz}. Poté by
LDAP dotaz mohl mít následující parametry:

\begin{table}[H]
	\begin{tabular}{ll}
	Prohledávána oblast: & \texttt{fqdn=client1.example.cz,cn=computers,cn=accounts,\$DC} \\
	Filtr:           		 & \texttt{"(memberOf=ipauniqueid=*cn=sudorules,cn=sudo,\$DC)"} \\
	Dotazované atributy: & \texttt{memberOf} \\
	\end{tabular}
\end{table}

S tímto pøístupem jsou ov¹em spojeny dva problémy. V \texttt{memberOf}
atributu záznamu pro klienta se nenachází sudo pravidla aplikovatelná na
kterýkoliv poèítaè. To znamená pravidla, která mají \texttt{hostCategory}
atribut. Tyto pravidla by tedy bylo nutné dodateènì stáhnout. Druhým problémem
jsou skupiny poèítaèù. Jesli-¾e je sudo pravidlo aplikovatelné na nìjakou
skupinu poèítaèù a klient je zároveò èlenem této skupiny. Pak je sudo pravidlo
na daného klienta aplikovatelné. Odkaz na toto pravidlo se ov¹em necházi v
záznamu daného poèítaèe, ale v záznamu dané skupiny. Odkazy na tyto pravidla by
bylo nutné získat pomocí dereference odkazù na dané skuipny poèítaèù.


%Pøedpokládejme sudo pravidlo\footnote{hodnoty nìkterých atributù byly zámìrnì
%zkráceny, kvùli velikosti schématu}, které je aplikováno na skupinu
%\texttt{nested-levX}. Tato skupina je zanoøenou podskupinou skuipny
%\texttt{nested}.  Klient s doménovým jménem \texttt{client1.example.cz} je
%èlenem skupiny \texttt{nested} a proto je na nìj dané pravidlo aplikovatelné.
%
%\begin{figure}[H]
%	\centering
%	\includegraphics[scale=0.90]{fig/sssd/new_design/hostgroups_problem.pdf}
%	\caption{Vnoøené skupiny poèítaèù}
%	\label{nested_hostgroups}
%\end{figure}

%{\color{red}{TODO: ta ¹ipka od sudo pravidla k zanoøené host groupì je naopak}}
%{\color{red}{TODO: ty hostgroups jsou ¹patnì, proto¾e je v záznamu toho poèítaèe
%mám :-(}}
%Odkaz na sudo pravidlo se ov¹em v záznamu klienta nebo skupiny \texttt{nested}
%nenachází. Nalézt bychom ho mohli a¾ v záznamu skupiny \texttt{nested-levX}.
%Pomocí LDAP protokolu je mo¾né získat pouze konkrétní záznam, popø. skupinu
%záznamù. Pomocí dereferenèního dotazu je také mo¾né získat záznamy, na které je
%odkazováno z jiných záznamù. Není ov¹em mo¾né v jednom dotazu získat záznamy,
%které se na sebe rekurzivnì odkazují. Jestli-¾e bychom chtìli získat pravidla ze
%zanoøených skupin, vedlo by to k rekurzivnímu dotazování. Pro
%potencionálnì rozsáhle zanoøené skupiny poèítaèù by to znamenalo mnoho LDAP
%dotazù a tedy zbyteènì nadmìrný sí»ový provoz. Z tìchto dùvodù není tento
%pøístup zcela vhodný.

\subsubsection{Specifikace klientského poèítaèe}
\label{design:rules_aplicable_to_host}
Je mo¾né vyu¾ít stejný pøístup, který pou¾ívá souèasná implementace LDAP
SUDO providera. Pro výbìr sudo pravidla aplikovatelného na konkrétní poèítaè v IPA
doménì jsou pou¾ity tøi atributy.

\begin{itemize}
	\item memberHost
	\item externalHost
	\item hostCategory
\end{itemize}

Za pøedpokladu, ¾e je sudo pravidlo na IPA server pøidáno korektnì, tj. pomocí
webového rozhraní nebo utilit \texttt{ipa-sudorule-add-*}. Pak atribut
\texttt{memberHost} bude v¾dy obsahovat plnì specifikované doménové jméno
poèítaèe\footnote{Fully Qualified Domain Name}. Nebo název skupiny
poèítaèù\footnote{hostgroup}. Jestli¾e je pravidlo aplikovatelné na libovolný
poèítaè, pak bude mít atribut \texttt{hostCategory} hodnotu \texttt{all} a jiné
atributy specifikující poèítaè se ji¾ v záznamu pravidla neobjeví. Parametry
LDAP dotazu pomocí kterého bychom získali záznamy v¹ech pravidel aplikovatelných
pro klientský poèítaè s doménovým jménem \texttt{client1.example.cz} mohou vypadat následovnì:

\begin{table}[H]
	\begin{tabular}{ll}
	Prohledávána oblast: & \texttt{cn=sudorules,cn=sudo,dc=example,dc=cz} \\
	Filtr:           		 & \texttt{"($|$(memberHost=client1.example.cz)(hostCategory=all))"} \\
	Dotazované atributy: & \texttt{memberOf} \\
	\end{tabular}
\end{table}


Problémem tohoto pøístupu je fakt, ¾e sudo provider nemá informaci o tom, ve
kterých skupinách poèítaèù se daný poèítaè nachází. Tato informace je dostupná
pouze na IPA serveru. Tento problém by bylo mo¾né odstranit dvìma zpùsoby:

\begin{enumerate}
	\item Sta¾ením sudo pravidel aplikovatelných pro libovolnou skupinu poèítaèù.
		V pøípadì rozsáhlé databáze pravidel a mnoho skupin poèítaèù by to ov¹em
		mohlo zpùsobit znaèný sí»ový provoz navíc.
	\item Nejprve získat seznam v¹ech skupin poèítaèù, kterými je daný klient
		èlenem a a¾ poté sestavit dotaz pro sta¾ení sudo pravidel. 
\end{enumerate}

\subsection{Sta¾ení sudo pravidel} 
Jestli-¾e víme, jak specifikovat sudo pravidla aplikovatelná na klientský
poèítaè, dal¹í krokem je samotné sta¾ení tìchto pravidel z IPA serveru. LDAP
sudo provider stahuje sudo pravidla pomocí jediného LDAP dotazu, proto¾e kompletní
záznamy sudo pravidel se nacházejí vìt¹inou v kontejneru
\texttt{ou=SUDOers,\$DC}\footnote{prohledávanou oblast je mo¾né specifikovat}. Sudo
pravidla na IPA serveru jsou ov¹em rozmístìna ve tøech kontejnerech, viz sekce
\ref{fjasdlfjasdkf}. Pro sta¾ení kompletních sudo pravidel se nabízí nìkolik
následujících pøístupù.

\subsubsection{1. Postupné dotazování}
První pøístup, který se nabízí je sta¾ení v¹ech pravidel aplikovatelných na daný
poèítaè. To znamená  konkrétní záznamy o sudo pravidlech z kontejneru
\texttt{cn=sudorules,cn=sudo,\$DC}. Pro tyto záznamy je ov¹em nezbytné je¹tì
stáhnout pøíkazy. Bylo by tedy nutné cyklit pøed sta¾ené záznamy a pro
ka¾dý odkaz na sudo pøíkaz provést LDAP dotaz jeho¾ výsledkem by ji¾ byl
konkrétní pøíkaz. Pokud by se jednalo o skupinu pøíkazu, pak by bylo nutné
provést dereferenèní dotaz, jeho¾ výsledkem by byl záznam, kde by se nacházel
ji¾ konkrétní pøíkaz. Tento pøístup popisuje diagram
\ref{rules_downloading:1st_approach}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.90]{fig/sssd/new_design/first_approach_rules_downloading.pdf}
	\caption{Sta¾ení kompletních sudo pravidel postupným dotazováním}
	\label{rules_downloading:1st_approach}
\end{figure}

Tento pøístup má tyto výhody: 
\begin{enumerate}
	\item Zpracování pravidel, které pøedstavuje pøeklad pravidel z IPA schématu do
		nativního LDAP schématu, viz. sekce \ref{ipa_sudo_rules_export}, je mo¾né
		provést v jediném cyklu.
	\item Nejsou stahována ¾ádná pøebyteèná sudo pravidla ani pøíkazy.
\end{enumerate}

Pøi rozsáhlé databázi sudo pravidel by to mohlo znamenat velké
mno¾ství LDAP dotazù. Pravidla by navíc mezi tìmito dotazy mohla být
modifikována.

\subsubsection{2. Dal¹í dotaz pro pøíkazy}
\label{rules_downloading:two_ldap_query}
Jiným pøístupem, který se nabízí, je sta¾ení v¹ech záznamù o sudo pravidlech
aplikovatelných na klientský poèítaè. Tyto záznamy projít a sestavit filtr pro
LDAP dotaz, který stáhne pøíkazy potøebné pro sta¾ená pravidla. 

\begin{figure}[H]
	\centering
	\includegraphics[scale=1.10]{fig/sssd/new_design/sudo_cmds_filter.pdf}
	\caption{Sestavení LDAP filtru pro sudo pøíkazy}
\end{figure}

Záznamy o skupinách sudo pøíkazù není nutné stahovat. Tyto skupiny toti¾ není
mo¾né do sebe zanoøovat. Ka¾dý sudo pøíkaz má atribut \texttt{memberOf}, který obsahuje
DN skupin pøíkazù, kterých je èlenem. Jestli¾e se \texttt{memberAllowCmd} nebo
\texttt{memberDenyCmd} odkazuje na skupinu sudo pøíkazù, pak je mo¾né dané
pøíkazy na základì \texttt{memberOf} atributu zjistit.

Výhodnou tohoto pøístupu je, ¾e vy¾aduje pouze dva LDAP dotazy pro sta¾ení v¹ech
záznamù potøebných pro pøevod sudo pravidel a zároveò nestahuje ¾ádné pøebyteèné
informace. 

\subsubsection{3. Sta¾ení v¹ech pøíkazù}\label{all_at_once}
Mno¾ina sudo pøíkazù je obecnì malá. Bylo by tedy mo¾né v jediném LDAP dotazu
stáhnout sudo pravidla aplikovatelná na klientský poèítaè a zároveò ve¹keré sudo
pøíkazy.  

Výhodou následujícího pøístupu je, ¾e pro sta¾ení kompletních sudo pravidel
postaèí jeden LDAP dotaz. Jejich následný pøevod je mo¾né provést v jednom
cyklu. Mù¾e ov¹em nastat situaci, kdy se na klienta bude aplikovat napø. pouze
jedno sudo pravidlo. Jestli¾e se na serveru nachází mnoho sudo pravidel a jejich
sudo pøíkazù, pak by to znamenalo pøená¹ení spousty záznamù, které nebudou
pou¾ity. Bylo by je ov¹em nutné zpracovat, co¾ pøiná¹í výkonnostní ztráty.


\subsection{Pøeklad pravidel}
Jeliko¾ sudo doká¾e zpracovat pouze pravidla, která odpovídají nativnímu LDAP
schématu. Je nutné provést pøeklad sta¾ených pravidel. Pøíklad tohoto pøekladu,
který v souèasné dobì provádí compat plugin demostruje schéma
\ref{sudo_rules_compat_plugin}. 

Nìkteré atributy je mo¾né pøelo¾it pouhým zkopírováním hodnoty a zámìnou jména
atributu. Mezi tyto atributy patøí napøíklad: \texttt{cn}, \texttt{externalUser}
nebo \texttt{ipaSudoOpt}. Atributy jako jsou: \texttt{memberHost} nebo
\texttt{memberUser} obsahují DN záznamu daného poèítaèe, popø. u¾ivatele.
Jeliko¾ projekt FreeIPA garantuje pou¾é schémata, je mo¾né dané hodnoty z DN
odvodit. Napøíklad z hodnoty atributu

\begin{table}[H]
	\begin{tabular}{l}
	\texttt{memberUser: cn=students,cn=groups,cn=accounts,\$DC}\\
	\end{tabular}
\end{table}

je mo¾né odvodit, ¾e je pravidlo aplikovatelné na v¹echny u¾ivatele skupiny
\uv{students}. U \texttt{*Category} atribtù je nutné provést pouze zámìnu malých
písmen za velká. 

\begin{table}[H]
	\begin{tabular}{l}
	\texttt{hostCategory: all => sudoCommand: ALL}\\
	\end{tabular}
\end{table}

Pro atributy \texttt{memberAllowCmd} a \texttt{memberDenyCmd} je nutné vyhledat
potøebný pøíkaz, popø. skupinu pøíkazù, jedná-li o odkaz na skupinu pøíkazù.

Pro algoritmus pøekladu pravidel byla vytvoøena pøekladová tabulka, které
definuje jakým zpùsobem má být provádìn pøeklad jednotlivých jmen a hodnot
atributù. Tato tabulka byla vytvoøena na základì implementace compat pluginu a
byla diskutována s vývojáøi projektu FreeIPA. Pøi jejím sestavovaní byla také
objevena chyba, které se vyskytuje ve webovém rozhraní serveru FreeIPA. To
umo¾òuje atributu \texttt{ipaSudoRunAsGroup} pøiøadit libovolnou skupinu.
Správnì by mìlo být mo¾né tomuto atributu pøiøadit pouze POSIX skupinu. Pro tuto
chybu byl vytvoøen ticket èíslo 
4314\footnote{https://fedorahosted.org/freeipa/ticket/4314\#no1}. Kompletní
pøekladovou tabulku je mo¾né nalézt v \ref{}.


\subsubsection{Algoritmus pøekladu pravidel}
Uva¾ujeme variantu stahování sudo pravidel popsanou v sekci
\ref{rules_downloading:two_ldap_query}, tj. sta¾ení pravidel pomocí dvou LDAP
dotazù. Po prvním dotazu získáme mno¾inu záznamù o sudo pravidlech. Druhým dotaz
vrátí mno¾inu záznamù o pøíkazech pro tyto pravidla.

Pro získání filtru, potøebného pro dotaz pro sudo pøíkazy, je nutné nejménì
jednou iterovat pøes mno¾inu sta¾ených sudo pravidel. Pøi této iteraci je ji¾
mo¾né provést pøeklad v¹ech atributù kromì tìch, které se odkazují na pøíkazy,
tj.  \texttt{memberAllowCmd} a \texttt{memberDenyCmd}. Jakmile obdr¾íme sudo
pøíkazy, mù¾eme provést druhou iteraci mno¾inou sudo pravidel, pøi které
doplníme potøebné pøíkazy.

\begin{figure}[h]
\centering
\includegraphics[scale=1.1]{fig/sssd/new_design/export_algorithm1.pdf}
\caption{Dvouprùchodový pøeklad IPA SUDO pravidel}
\label{a}
\end{figure}

Tento zpùsob pøekladu má ov¹em následující nevýhody:
\begin{itemize}
	\item Pøi druhém prùchodu nevíme, kde se nepøelo¾ené atributy
		\texttt{memberAllowCmd} a \texttt{memberDenyCmd} nacházejí a proto je nutné
		je v pravidlech znovu dohledat.
	\item Pro ka¾dý \texttt{memberAllowCmd} a \texttt{memberDenyCmd} atribut je
		nutné vyhledat potøebný pøíkaz, co¾ vede k mnoha iteracím nad
		\textbf{nemìnící se} mno¾inou pøíkazù.
\end{itemize}

Optimalizací tohoto pøístupu by mohlo být uchování hodnot odkazù na pøíkazy a
pravidla ve kterých se vyskytla. Stále je ov¹em nutné \texttt{N-krát} iterovat
mno¾inou pøíkazu, kde \texttt{N} je poèet odkazù na pøíkazy v záznamech sudo
pravidel. Tento problémy je mo¾né odstranit za pomoci pou¾ití ha¹ovací tabulky,
který znározòuje schéma \ref{hash_table}.
Jako klíè mù¾e poslou¾it DN sudo pøíkazu nebo skupiny pøíkazù. Hodnotou polo¾ky
této tabulky poté mù¾e být seznam v¹ech pravidel, ve kterých se daný pøíkaz nebo
skupina pøíkazù vyskytuje.

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.85]{fig/sssd/new_design/hash_table.pdf}
	\caption{Pou¾ití ha¹ovací tabulky pro pøeklad atributu s pøíkazy}
	\label{hash_table}
\end{figure}

{\color{red}{TODO: je nutno poøe¹it to poøadí allowed a denied pøíkazù =>2
prùchody pøes pøíkazy, 1. dívám se na aloowed, 2.dívám se na denied}}

Hlavní vyhodou tohoto pøístupu je sní¾ení poètu iterací. Tento pøístup je
vhodný v pøípadech kdy pracujeme s velkým poètem záznamù o sudo pravidlech a
pøíkazech.  Typicky tedy pøi provádìní úplných aktualizací. Pøi aktualizaci
pravidel a prùbì¾ných aktualizacích budou tyto mno¾iny obecnì men¹í. Pou¾ití
ha¹ovací tabulky by tedy v tìchto pøípadech nebylo nutné. Typ aktualizace je
pøed znám pøed samotným sta¾ením pravidel a poèet sta¾ených sudo pravidel po
prvním dotazu. Je tedy mo¾né provádìt výbìr zvoleného algoritmu na základì
tìchto údajù.

Jestli¾e máme zvolený algoritmus pøekladu pravidel, pak je nutné rozhodnout, kdo
tento pøedklad bude realizovat. Nabízí se øe¹ení ulo¾it sta¾ená sudo pravidla v
IPA formátu pøímo do sysdb a nechat sudo respondera tyto pravidla pøekládát.
Tento pøístup sice je realizovatelný, ale není správný z pohledu architektury
SSSD.  Jak bylo øeèeno v sekci \ref{sssd:architecture}, respondeøi mají s pomocí
cache pamìti pouze co nejrychleji odpovídat na dotazy klientských aplikací. Z tohoto
dùvodu musí být do sysdb ulo¾ena ji¾ pøelo¾ená sudo pravidla a jejich zpracování
tedy musí provést sudo provider. V tomto pøípadì tedy pøevod pravidel musí
realizovat navrhovaný IPA SUDO provider.

\subsection{Vyu¾itelnost LDAP pluginu}
IPA SUDO provider bude provádìt velmi podobnou funkcionalitu jako LDAP SUDO
provider. Mohlo by
se tedy zdát, ¾e jediná úprava, kterou je nutno provést v LDAP SUDO providerovi, je pøidání pøekladu
pravidel pøed samotným ulo¾ením tìchto pravidel do cache pamìti. Pøevod pravidel je
ov¹em  specifiký pro IPA providera. V kódu LDAP providera by se tedy muselo
vyskytnou volání funkcí, které by se nacházely v IPA providerovi. Tento pøístup je sice
realizovatelný\footnote{První prototyp byl zalo¾en na této my¹lence}, ov¹em
neodpovídá filozofii a pou¾itelnosti SSSD. Kód zaji¹tující pøeklad pravidel by
byl souèástí dynamické knihovny \texttt{libsss\_ipa.so} zatímco kód
LDAP sudo providera  
se nachází v knihovnì \texttt{libsss\_ldap.so}. SSSD je ov¹em mo¾no nainstalovat
a pou¾ívat bez podpory IPA. Napøíklad je mo¾no vyu¾ít SSSD pouze ke cachování
sudo pravidel ulo¾ených na LDAP serveru, kde se samozøejmì nacházejí v nativním
LDAP SUDO schématu. V takovém pøípadì není potøeba sudo pravidla pøekládat a
SSSD je nakonfigurováno tak, aby vyu¾ilo LDAP sudo providera z knihovny \texttt{libsss\_ldap.so}. Knihovna
\texttt{libsss\_ipa.so} tedy není potøeba. Pøi naèítání \texttt{libsss\_ldap.so} by poté nastal
problém, jeliko¾ by se odkazovala na funkce, které se nacházejí v knihovnì,
která není a ani by nebyla naètena do pamìti. Proto není mo¾né z LDAP sudo
providera volat kód z IPA sudo providera.
Je ov¹em mo¾né z IPA providera volat kód LDAP providera, LDAP provider je
mo¾né si pøedstavit jako stavební blok nad kterým mohou stavìt
odstatní provideøi a toho je mo¾no vyu¾ít. Vet¹í zásah do LDAP providera by také
mohl vnést mnoho chyb do ji¾ fungujícího a odladìného kódu. 

Asynchronní modul \texttt{sdap\_async\_sudo.c} provádí sta¾ení a ulo¾ení sudo
pravidel v nativním LDAP schématu do sysdb. Je tedy mo¾né vyu¾ít této
asynchronní události pro sta¾ení pravidel v IPA SUDO schématu. Pro tyto pravidla
je nutné dále stáhnout sudo pøíkazy a poté provést pøeklad tìchto pravidel.
Jestli-¾e máme sudo pravidla pøelo¾ena z IPA SUDO schématu do nativního LDAP
schématu, mù¾eme opìt vyu¾ít zmiòovaného modulu pro jejich odstranìní nebo
ulo¾ení do cache pamìti.

Dal¹í vyu¾itelnou èástí mù¾e být plánování pravidelných aktualizací. V¹echny
typy aktualizací musí zùstat zachovány a proto mù¾eme procedury pro toho
plánování v IPA pluginu vyu¾ít.

\section{Implementace}
Pro specifikaci pravidel aplikovatelných na klientský poèítaè byl vybrán pøístup
popsaný v podsekci \ref{design:rules_aplicable_to_host}. Výbìr tìchto pravidel
je tedy proveden dotazem do kontejneru:

\begin{table}[H]
	\begin{tabular}{l}
	\texttt{cn=sudorules,cn=sudo,\$DC}\\
	\end{tabular}
\end{table}

Filtr
specifikuje klienta pomocí FQDN daného poèítaèe a skupin poèítaèù ve kterých je
èlenem. Pro získání tìchto skupin je pou¾ito asynchronní
volání \texttt{ipa\_host\_info\_send()}. Základní filtr, který je pou¾it pro
úplnou aktualizaci vypadá následovnì:

\lstinputlisting{DVD/ldap_filters/ipa_sudo_provider/full_refresh_filter}

Pøi aktualizaci pravidel jsou pouze pøidána jména pravidel, stejnì jako u LDAP
sudo providera. Zde by také bylo mo¾né vyu¾ít atributu \texttt{ipaUniqueID}, který jednoznaènì
identifikuje sudo pravidlo. To by ov¹em vy¾adovalo úpravu sudo respondera, která by
nepøinesla ¾ádnou výhodu. Jeliko¾ jsou hodnoty atributù \texttt{cn}, tj. jména sudo pravidel, 
jedineèná i v IPA SUDO schématu, není potøeba tuto zmìnu provádìt. Pøi prùbì¾ných
aktualizacích je opìt vyu¾ito atributu \texttt{EntryUSN}, k detekci novì
pøidaných nebo modifikovaných sudo pravidel.

Sta¾ení kompletních sudo pravidel, tj. pravidla a pøíkazy, je provedeno pomocí
dvou dotazù pro v¹echny typy aktualizací. Pro sta¾ení pravidel jsou tedy
zapotøebí \textbf{nejvý¹e tøi} LDAP dotazy a nejménì dva v pøípadì, ¾e sta¾ená
pravidla neobsahují odkazy na dal¹í záznamy, tj. odkazy na záznamy pøíkazù.
Zva¾ována byla také varianta kdy by se pro úplnou aktualizaci   postupovalo
podle metody \ref{all_at_once}, tzn.  sta¾ení sudo pravidel a v¹ech pøíkazù v
jediném LDAP dotazu. Zde ov¹em vzniká problém s SDAP rozhraním, které neumo¾òuje
specifikovat více ne¾ jednu mapu.  Proto není mo¾né obdr¾et záznamy, které
nemají alespoò jednu stejnou tøídu. Sudo pravidla v IPA SUDO schématu mají tøídu
\texttt{ipaSudoRule}, zatímco pøíkazy \texttt{ipaSudoCmd}. Tento problém je
blí¾e popsán v sekci \ref{sdap}. 

Jako øe¹ení by se nabízelo vyu¾ít druhého mo¾ného rozhraní tedy
\texttt{sdap\_deref\_search\_send}, které dovoluje specifikovat více map.
Problémem ov¹em je, ¾e neumo¾òuje specifikovat filtr a tedy mno¾inu záznamù (sudo
pravidel) ze kterých by bylo mo¾né pøes odkazy získat odkazované záznamy (sudo pøíkazy). Z
implementaèního hlediska by tyto rozhraní pro daný úèel bylo mo¾né upravit. 
I kdyby tato zmìna byla provdena, stále by byl problém s odkazy na skupiny
pøíkazù. V tìchto záznamech bychom toti¾ na¹li opìt odkazy na pøíkazy, co¾ by
znamenalo nal¹í LDAP dotaz.

Pro pøeklad pravidel byl zvolen základní algoritmus s drobnými optimalizacemi,
který se pøi testování osvìdèil jako dostateèný pro malou mno¾inu pravidel. V
pøípadì výkonnostních problémù je mo¾no pøidat podporu hashovací tabulky, která
by pøi velké databázi pravidel mohla zvý¹it rychlost pøekladu.

Pro prvotní sta¾ení pravidel byl vyu¾it LDAP sudo provider. Konkrétnì jeho
asynchronní modul popsaný v sekci \ref{async_engine_of_ldap_provider}. To
vy¾adovalo úpravu, která je zobrazena na schématu
\ref{sdap_async_sudo_ipa_change}.  Z tohoto modulu jsou dále vyu¾ity funkce,
které zaji¹»ují práci s cache pamìtí, tzn.  odstraòování expirovaných a ukládání
novì sta¾ených a pøelo¾ených pravidel.  Jak bylo popsáno v sekci
\ref{ldap_sudo_refresh_scheduling} plánování aktualizací sudo pravidel je
slo¾itý proces pøi kterém je tøeba øe¹it urèité problémy. Tyto problémy øe¹í
nový plánovaè SSSD zvaný \texttt{ptask}\footnote{Popis rozhraní se nachází v
hlavièkovém souboru \texttt{sssd/src/providers/dp\_ptask.h}}. Proto nový IPA
SUDO provider tento plánovaè vyu¾ivá pro plánování v¹ech tøí typù aktualizací.
Výsledné schéma asynchronních událostí ipa sudo providera poté zobrazuje schéma
\ref{ipa_plugin_tevents_flow}.

\section{Testování}
Pro tvorbu jednotkových testù vyu¾ívá SSSD framework
cmocka\footnote{http://cmocka.org/}, který podporuje Mock objekty. Pomocí tìchto
objektù je mo¾né simulovat jakýkoliv reálný objekt. V na¹em pøípadì byl jako Mock
objekt zvolen IPA server, tj. ve¹kerá rozhraní zaji¹tující komunikaci s IPA
serverem. Jednotkové testy je tedy mo¾né provádìt bez pøítomnosti IPA serveru èi
pøipojení k síti. Mock objekty tedy simulují IPA server a sudo pravidla, která
se na nìm nacházejí.

\subsection{Metodika}
Reálná sudo pravidla si ka¾dá spoleènost peèlivì støe¾í. Proto nebylo mo¾né
taková pravidla získat. Pro testování jsem tedy vytvoøil sadu pravidel, které
pokrývají tyto pøípady pou¾ití:

\begin{itemize}
	\item sudo pravidla jejich¾ atributy se neodkazují na ¾ádné objekty (napø.
		u¾ivatele nebo poèítaèe) IPA domény
	\item pravidla, která neobsahují odkazy na sudo pøíkazy
	\item	komplexní pravidla jejich¾ atributy se odkazují na jiné objekty IPA
		domény
	\item	výskyt neexistujícího atributu
	\item	výskyt atributu, který se odkazuje na neexistující objekt v IPA doménì
	\item pøípad, kdy se na serveru nenacházejí ¾ádná pravidla
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 5. Závìr
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Závìr}
\begin{itemize}
	\item 1. ostavec - vem cíle a shrò co se udìlalo
	\begin{itemize}
		\item	co se mi podaøilo naimplementovat a otestovat
		\item	co na to komunita sssd
		\item	vìci nad rámec zadání jako patche nebo dokumentace, která neexistovala
		\item nauèil jsem se pou¾ívat nové knihovny (talloc, tevent, cmock
			framework)
		\item nauèil jsem se nové paradigma programování
	\end{itemize}
	\item 2. odstavec - dal¹í vìci na kterých bych se dalo zapracovat
	\begin{itemize}
		\item performance testy, od lidí, kteøí pou¾ívají IPA s velkou databází
	\end{itemize}
\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

{\color{red}
\chapter{Zkontroloval pøed odevzdáním}
\begin{itemize}
	\item psaní odrá¾ek http://prirucka.ujc.cas.cz/?id=870
	\item vìty s teèkami v popisu obrázku?
	\item to samé pro footnotes...
	\item ne pøevod pravidel, ale \textbf{pøeklad pravidel}!
	\item k první FQDN\footnote{Fully Qualified Domain Name} dej footnote pak u¾ ne
	\item nové pojmy kurzívou a dùle¾ité vìci tuènì
	\item poznámky o èeské gramatice co mám na wikinì
	\item SUDO -> sudo, pokud to není v názvu napø IPA SUDO Provider
	\item \uv{èeské úvozovky}
	\item pøetáhnout to pøes nìjaký czech grammar checker ala word...
	\item korektura pou¾íté literatury - odkazy na obsah DVD
	\item od zmínìní \textbf{sysdb} v subsekci\ref{sysdb}, zamìò v¹echnu cache
		pamìt za sysdb
\end{itemize}
}
%=========================================================================
